import { createOptimizedPicture } from '../../scripts/aem.js';
import { moveInstrumentation } from '../../scripts/scripts.js';

export default function decorate(block) {
  const sectionContainer = document.createElement('section');
  sectionContainer.classList.add('upcoming-drive-section-container', 'homeSlot');
  sectionContainer.id = 'upcomingDrive';

  // Extract and move the background image
  const backcoverRow = block.children[0];
  if (backcoverRow) {
    const backcoverImg = backcoverRow.querySelector('img');
    if (backcoverImg) {
      const pic = createOptimizedPicture(backcoverImg.src, backcoverImg.alt);
      pic.classList.add('upcoming-drive-section-backcover');
      moveInstrumentation(backcoverImg, pic.querySelector('img'));
      sectionContainer.append(pic);
    }
  }

  // Extract and move the 'Upcoming Drives' text
  const uptextRow = block.children[1];
  if (uptextRow) {
    const uptextDiv = document.createElement('div');
    uptextDiv.classList.add('upcoming-drive-section-uptext');
    uptextDiv.append(...uptextRow.children[0].childNodes);
    moveInstrumentation(uptextRow.children[0], uptextDiv);
    sectionContainer.append(uptextDiv);
  }

  const wrapperDiv = document.createElement('div');
  wrapperDiv.classList.add('upcoming-drive-section-wrapper');

  // Add previous button
  const prevButton = document.createElement('button');
  prevButton.classList.add('upcoming-drive-section-btn-slide', 'upcoming-drive-section-prev-slide');
  const prevButtonImgRow = block.children[2]; // Assuming this row contains the prev button image
  if (prevButtonImgRow) {
    const prevImg = prevButtonImgRow.querySelector('img');
    if (prevImg) {
      const clonedPrevImg = prevImg.cloneNode(true);
      prevButton.append(clonedPrevImg);
    } else {
      // Fallback if image not directly in row, check for anchor
      const anchor = prevButtonImgRow.querySelector('a');
      if (anchor) {
        const img = document.createElement('img');
        img.src = anchor.href;
        img.alt = anchor.title || '';
        prevButton.append(img);
      }
    }
  }
  wrapperDiv.append(prevButton);

  const sliderContainerDiv = document.createElement('div');
  sliderContainerDiv.classList.add('upcoming-drive-section-slider-container');

  const sliderDiv = document.createElement('div');
  sliderDiv.classList.add('upcoming-drive-section-slider');

  const sliderTrackUl = document.createElement('ul');
  sliderTrackUl.classList.add('upcoming-drive-section-slider-track');

  // Iterate over upcomingDrive items (starting from the third row in block.children)
  const upcomingDriveItems = Array.from(block.children).slice(3, -1); // Exclude first 3 rows and last row (next button)

  upcomingDriveItems.forEach((row) => {
    const upcomingDriveItemLi = document.createElement('li');
    upcomingDriveItemLi.classList.add('upcoming-drive-section-item-s');
    moveInstrumentation(row, upcomingDriveItemLi); // Transfer instrumentation for the whole item

    const contentDiv = document.createElement('div');

    // Image
    const imageCell = row.querySelector('[data-aue-prop="image"]');
    if (imageCell) {
      const img = imageCell.querySelector('img');
      if (img) {
        const pic = createOptimizedPicture(img.src, img.alt);
        moveInstrumentation(img, pic.querySelector('img'));
        contentDiv.append(pic);
      } else {
        // Look for <a> generated by aem-content field
        const anchor = imageCell.querySelector('a[href$=".png"], a[href$=".jpg"], a[href$=".jpeg"], a[href$=".webp"]');
        if (anchor) {
          const newImg = document.createElement('img');
          newImg.src = anchor.href;
          newImg.alt = anchor.title || '';
          contentDiv.append(newImg);
          moveInstrumentation(anchor, newImg);
        }
      }
    }

    // Title
    const titleCell = row.querySelector('[data-aue-prop="title"]');
    if (titleCell) {
      const h3Red = document.createElement('h3');
      h3Red.classList.add('upcoming-drive-section-h3-red');
      h3Red.append(...titleCell.childNodes);
      moveInstrumentation(titleCell, h3Red);
      contentDiv.append(h3Red);
    }

    // Subtitle
    const subtitleCell = row.querySelector('[data-aue-prop="subtitle"]');
    if (subtitleCell) {
      const h3Small = document.createElement('h3');
      h3Small.classList.add('upcoming-drive-section-h3-small');
      h3Small.append(...subtitleCell.childNodes);
      moveInstrumentation(subtitleCell, h3Small);
      contentDiv.append(h3Small);
    }

    // Description
    const descriptionCell = row.querySelector('[data-aue-prop="description"]');
    if (descriptionCell) {
      const p = document.createElement('p');
      p.append(...descriptionCell.childNodes);
      moveInstrumentation(descriptionCell, p);
      contentDiv.append(p);
    }

    upcomingDriveItemLi.append(contentDiv);

    // CTA
    const ctaCell = row.querySelector('[data-aue-prop="cta"]');
    const ctaIconCell = row.querySelector('[data-aue-prop="ctaIcon"]');

    if (ctaCell) {
      const ctaLink = ctaCell.querySelector('a');
      if (ctaLink) {
        const ctaAnchor = document.createElement('a');
        ctaAnchor.classList.add('upcoming-drive-section-cta');
        ctaAnchor.href = ctaLink.href;
        ctaAnchor.rel = 'no-follow';

        const ctaTextP = document.createElement('p');
        ctaTextP.append(...ctaLink.childNodes);
        moveInstrumentation(ctaLink, ctaTextP); // Move instrumentation from the original link to the new paragraph
        ctaAnchor.append(ctaTextP);

        if (ctaIconCell) {
          const ctaIconImg = ctaIconCell.querySelector('img');
          if (ctaIconImg) {
            const clonedCtaIconImg = ctaIconImg.cloneNode(true);
            ctaAnchor.append(clonedCtaIconImg);
          } else {
            const iconAnchor = ctaIconCell.querySelector('a');
            if (iconAnchor) {
              const img = document.createElement('img');
              img.src = iconAnchor.href;
              img.alt = iconAnchor.title || '';
              ctaAnchor.append(img);
            }
          }
        }
        upcomingDriveItemLi.append(ctaAnchor);
      }
    }
    sliderTrackUl.append(upcomingDriveItemLi);
  });

  sliderDiv.append(sliderTrackUl);
  sliderContainerDiv.append(sliderDiv);
  wrapperDiv.append(sliderContainerDiv);

  // Add next button
  const nextButton = document.createElement('button');
  nextButton.classList.add('upcoming-drive-section-btn-slide', 'upcoming-drive-section-next-slide');
  const nextButtonImgRow = block.children[block.children.length - 1]; // Last row for next button image
  if (nextButtonImgRow) {
    const nextImg = nextButtonImgRow.querySelector('img');
    if (nextImg) {
      const clonedNextImg = nextImg.cloneNode(true);
      nextButton.append(clonedNextImg);
    } else {
      // Fallback if image not directly in row, check for anchor
      const anchor = nextButtonImgRow.querySelector('a');
      if (anchor) {
        const img = document.createElement('img');
        img.src = anchor.href;
        img.alt = anchor.title || '';
        nextButton.append(img);
      }
    }
  }
  wrapperDiv.append(nextButton);

  sectionContainer.append(wrapperDiv);

  block.innerHTML = '';
  block.append(sectionContainer);

  // Add slider functionality (simplified, actual implementation would be more complex)
  let slideIndex = 0;
  const slides = sliderTrackUl.children;

  function showSlides() {
    for (let i = 0; i < slides.length; i += 1) {
      slides[i].style.display = 'none';
    }
    if (slides.length > 0) {
      slides[slideIndex].style.display = 'block';
    }
  }

  function plusSlides(n) {
    slideIndex += n;
    if (slideIndex >= slides.length) {
      slideIndex = 0;
    }
    if (slideIndex < 0) {
      slideIndex = slides.length - 1;
    }
    showSlides();
  }

  prevButton.addEventListener('click', () => plusSlides(-1));
  nextButton.addEventListener('click', () => plusSlides(1));

  showSlides();
}
