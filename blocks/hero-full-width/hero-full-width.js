import { createOptimizedPicture } from '../../scripts/aem.js';
import { moveInstrumentation } from '../../scripts/scripts.js';

export default function decorate(block) {
  const children = Array.from(block.children);
  block.innerHTML = '';

  const heroFullWidthCover = document.createElement('div');
  heroFullWidthCover.classList.add('hero-full-width__cover');
  block.append(heroFullWidthCover);

  const heroFullWidthBackground = document.createElement('div');
  heroFullWidthBackground.classList.add('hero-full-width__background');
  const heroFullWidthBackgroundWrapper = document.createElement('div');
  heroFullWidthBackgroundWrapper.classList.add('hero-full-width__background-wrapper', 'zoom-out');
  heroFullWidthBackground.append(heroFullWidthBackgroundWrapper);

  let backgroundVideoSource = children[0].querySelector('[data-aue-prop="backgroundVideo"]');
  if (!backgroundVideoSource) {
    // Look for <a> generated by aem-content field
    const anchor = children[0].querySelector('a[href$=".mp4"], a[href$=".mov"], a[href$=".webm"]');
    if (anchor)
      backgroundVideoSource = anchor;
  }

  if (backgroundVideoSource) {
    const video = document.createElement('video');
    video.classList.add('hero-full-width__background-video');
    video.setAttribute('playsinline', '');
    video.setAttribute('muted', '');
    video.setAttribute('loop', '');
    video.setAttribute('autoplay', '');
    const source = document.createElement('source');
    source.setAttribute('src', backgroundVideoSource.getAttribute('href') || backgroundVideoSource.textContent.trim());
    source.setAttribute('type', 'video/mp4');
    video.append(source);
    heroFullWidthBackgroundWrapper.append(video);
    moveInstrumentation(backgroundVideoSource, source);
  }

  const backgroundPoster = document.createElement('img');
  backgroundPoster.setAttribute('alt', 'Background poster image');
  backgroundPoster.setAttribute('loading', 'lazy');
  backgroundPoster.classList.add('hero-full-width__background-poster');
  backgroundPoster.style.display = 'none';
  heroFullWidthBackgroundWrapper.append(backgroundPoster);
  block.append(heroFullWidthBackground);

  const heroFullWidthContent = document.createElement('div');
  heroFullWidthContent.classList.add('hero-full-width__content');

  const headingWrapper = document.createElement('div');
  headingWrapper.classList.add('hero-slide-wrap');
  const headingSlideUp = document.createElement('div');
  headingSlideUp.classList.add('hero-slide-up');
  headingSlideUp.setAttribute('data-slide-type', 'slide-up');
  const headingDiv = document.createElement('div');
  headingDiv.classList.add('hero-full-width__content__title');
  headingDiv.setAttribute('tabindex', '0');
  const heading = children[0].querySelector('[data-aue-prop="heading"]');
  if (heading) {
    headingDiv.append(...heading.childNodes);
    moveInstrumentation(heading, headingDiv);
  }
  headingSlideUp.append(headingDiv);

  const descriptionDiv = document.createElement('div');
  descriptionDiv.classList.add('hero-full-width__content__description');
  descriptionDiv.setAttribute('tabindex', '0');
  const description = children[0].querySelector('[data-aue-prop="description"]');
  if (description) {
    descriptionDiv.append(...description.childNodes);
    moveInstrumentation(description, descriptionDiv);
  }
  headingSlideUp.append(descriptionDiv);
  headingWrapper.append(headingSlideUp);
  heroFullWidthContent.append(headingWrapper);

  const ctaWrapper = document.createElement('div');
  ctaWrapper.classList.add('hero-slide-wrap');
  const ctaSlideUp = document.createElement('div');
  ctaSlideUp.classList.add('hero-slide-up');
  ctaSlideUp.setAttribute('data-slide-type', 'slide-up');
  const ctasDiv = document.createElement('div');
  ctasDiv.classList.add('hero-full-width__content--ctas');

  const primaryCta = children[0].querySelector('[data-aue-prop="primaryCta"]');
  if (primaryCta) {
    const primaryCtaLink = document.createElement('a');
    primaryCtaLink.classList.add('hero-cta', 'hero-cta__secondary', 'hero-primaryCta');
    primaryCtaLink.setAttribute('target', '_self');
    primaryCtaLink.setAttribute('data-palette', 'palette-light');
    primaryCtaLink.setAttribute('href', primaryCta.getAttribute('href') || '#');
    primaryCtaLink.setAttribute('aria-label', primaryCta.textContent.trim());
    const span = document.createElement('span');
    span.classList.add('hero-cta__label');
    span.textContent = primaryCta.textContent.trim();
    primaryCtaLink.append(span);
    ctasDiv.append(primaryCtaLink);
    moveInstrumentation(primaryCta, primaryCtaLink);
  }

  const heroChevronWrapper = document.createElement('div');
  heroChevronWrapper.classList.add('hero-chevron-wrapper');
  const chevronButton = document.createElement('button');
  chevronButton.setAttribute('type', 'button');
  chevronButton.classList.add('hero-chevron-icon');
  chevronButton.setAttribute('aria-label', 'Open video modal');
  heroChevronWrapper.append(chevronButton);

  const secondaryCta = children[0].querySelector('[data-aue-prop="secondaryCta"]');
  if (secondaryCta) {
    const secondaryCtaLink = document.createElement('a');
    secondaryCtaLink.classList.add('hero-cta', 'hero-cta__link', 'hero-secondaryCta');
    secondaryCtaLink.setAttribute('target', '_self');
    secondaryCtaLink.setAttribute('data-palette', 'palette-light');
    secondaryCtaLink.setAttribute('href', secondaryCta.getAttribute('href') || '#');
    secondaryCtaLink.setAttribute('aria-label', secondaryCta.textContent.trim());
    const iconSpan = document.createElement('span');
    iconSpan.classList.add('hero-cta__icon', 'qd-icon', 'qd-icon--cheveron-right');
    iconSpan.setAttribute('aria-hidden', 'true');
    const labelSpan = document.createElement('span');
    labelSpan.classList.add('hero-cta__label');
    labelSpan.textContent = secondaryCta.textContent.trim();
    secondaryCtaLink.append(iconSpan, labelSpan);
    heroChevronWrapper.append(secondaryCtaLink);
    moveInstrumentation(secondaryCta, secondaryCtaLink);
  }
  ctasDiv.append(heroChevronWrapper);
  ctaSlideUp.append(ctasDiv);
  ctaWrapper.append(ctaSlideUp);
  heroFullWidthContent.append(ctaWrapper);

  const dialog = document.createElement('dialog');
  dialog.classList.add('hero-full-width__content--modal');
  dialog.setAttribute('id', 'home-page-video-dialog');
  dialog.setAttribute('closedby', 'any');
  dialog.setAttribute('aria-modal', 'true');
  dialog.setAttribute('aria-label', 'Video Modal');

  const form = document.createElement('form');
  form.setAttribute('method', 'dialog');
  const closeButton = document.createElement('button');
  closeButton.classList.add('hero-full-width__content--modal__close-button');
  closeButton.setAttribute('aria-label', 'Close Video');
  closeButton.setAttribute('tabindex', '0');
  closeButton.textContent = 'X';
  form.append(closeButton);
  dialog.append(form);

  const heroVideoDiv = document.createElement('div');
  heroVideoDiv.classList.add('hero-video', 'hero-full-width__content--modal__video');
  const heroVideoContainer = document.createElement('div');
  heroVideoContainer.classList.add('hero-video-container', 'hero-show-controls');

  const controlsDiv = document.createElement('div');
  controlsDiv.classList.add('hero-video-container__controls');

  const timerDiv = document.createElement('div');
  timerDiv.classList.add('hero-video-container__controls__timer');
  const progressArea = document.createElement('div');
  progressArea.classList.add('hero-video-container__controls__timer__progress-area');
  progressArea.innerHTML = '<span class="hero-video-container__controls__timer__progress-area__progress-bar"></span><span class="hero-video-container__controls__timer__progress-area__pointer"></span><span class="hero-video-container__controls__timer__progress-area__progress-pending"></span>';
  const currentTime = document.createElement('p');
  currentTime.classList.add('hero-video-container__controls__timer__current-time');
  currentTime.textContent = '00:00';
  const duration = document.createElement('p');
  duration.classList.add('hero-video-container__controls__timer__duration');
  duration.textContent = '00:00';
  timerDiv.append(progressArea, currentTime, duration);
  controlsDiv.append(timerDiv);

  const buttonsDiv = document.createElement('div');
  buttonsDiv.classList.add('hero-video-container__controls__buttons');
  buttonsDiv.innerHTML = `
    <button class="hero-video-container__controls__buttons__play-button hero-video-container__controls__buttons--button">
        <span class="hero-video-container__controls__buttons__icon qd-icon qd-icon--play"></span>
    </button>
    <button class="hero-video-container__controls__buttons__mute-button hero-video-container__controls__buttons--button">
        <span class="hero-video-container__controls__buttons__icon qd-icon qd-icon--volume"></span>
    </button>
    <button class="hero-video-container__controls__buttons__fullscreen-button hero-video-container__controls__buttons--button">
        <span class="hero-video-container__controls__buttons__icon qd-icon qd-icon--fullscreen"></span>
    </button>
  `;
  controlsDiv.append(buttonsDiv);
  heroVideoContainer.append(controlsDiv);

  if (backgroundVideoSource) {
    const modalVideo = document.createElement('video');
    modalVideo.classList.add('hero-video-container__video');
    modalVideo.setAttribute('playsinline', '');
    modalVideo.setAttribute('webkit-playsinline', '');
    modalVideo.setAttribute('muted', 'true');
    modalVideo.setAttribute('autoplay', '');
    const modalSource = document.createElement('source');
    modalSource.setAttribute('src', backgroundVideoSource.getAttribute('href') || backgroundVideoSource.textContent.trim());
    modalSource.setAttribute('type', 'video/mp4');
    modalVideo.append(modalSource);
    heroVideoContainer.append(modalVideo);
  }

  heroVideoDiv.append(heroVideoContainer);
  dialog.append(heroVideoDiv);
  heroFullWidthContent.append(dialog);

  block.append(heroFullWidthContent);
}
